<!doctype html>
<html lang="en">
<head>
  <!-- BUILD: OP_PANEL v12.3.2 -->
  <!-- BUILD: OP_INLINE v12.3 Sep15-chi -->
  <!-- EXWIFE v12.3 + UX POLISH v1: banner/countdown, progress numbers, toasts -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EXWIFE Presale (Mainnet) — v12.3</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/img/exwife-hero.png" />

  <!-- Ethers UMD (single include; no async/defer) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

  <!-- ENV + minimal ABI -->
  <script>
    window.EXWIFE_ENV = {
      network: 'mainnet',
      rpc: 'https://eth.drpc.org',
      presale: '0xF4A37B656A33d418FB37280c9304274078A9b3ed',
      token:   '0xd0F4f922891cBfaDB73511df7af66dE15DA93C94',
      symbol:  'EXWIFE',
      goalEth: 1200
    };
    window.GOAL_ETH = 1200;
    window.PRESALE_ADDRESS = window.EXWIFE_ENV.presale;

    // Minimal ABI (reads + buy); include events to avoid unknown-fragment warnings
    window.PRESALE_ABI_MIN = [
      "function paused() view returns (bool)",
      "function totalRaisedWei() view returns (uint256)",
      "function weiRaised() view returns (uint256)",
      "function buy() payable",
      "event Paused(address indexed account)",
      "event Unpaused(address indexed account)"
    ];
  </script>

  <!-- Safe subscription shim: skip subscribing to missing events -->
  <script>
    (function(){
      if (!window.ethers || !ethers.Contract) return;
      const _on = ethers.Contract.prototype.on;
      ethers.Contract.prototype.on = function(event, listener) {
        try {
          if (typeof event === 'string' && this.interface && !this.interface.getEvent(event)) {
            console.warn('[EXWIFE] Skipping subscription to missing event:', event);
            return this;
          }
        } catch (e) {
          console.warn('[EXWIFE] Event check failed, skipping:', event, e);
          return this;
        }
        return _on.call(this, event, listener);
      };
    })();
  </script>

  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; background:#0e0f12; color:#e7e7ea; }
    .wrap { max-width:680px; margin:40px auto; padding:0 16px; }
    .card { background:#141417; border:1px solid #222; border-radius:14px; padding:18px; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .pill { background:#1c1d22; border:1px solid #2a2b31; padding:6px 10px; border-radius:999px; }
    .btn { background:#2d6cdf; border:none; color:#fff; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .progress { width:100%; height:14px; background:#1a1b20; border:1px solid #2a2b31; border-radius:10px; overflow:hidden; margin-top:8px; }
    .bar { height:100%; width:2%; background:#22c55e; transition: width .6s ease; }
    code { background:#101115; border:1px solid #222; padding:2px 6px; border-radius:8px; }
    .muted { opacity:.85; }
    a { color:#9bbcff; text-decoration:none; }
    a:hover { text-decoration:underline; }
    input::placeholder { color:#9aa; }

    /* === UX POLISH v1: banner + progress numbers + toasts === */
    .banner {
      display:flex; gap:.5rem; align-items:center; justify-content:center;
      padding:.6rem .9rem; margin:12px auto 14px; max-width:980px;
      background:#111; color:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.25);
      font-weight:600;
    }
    .banner .countdown { opacity:.9; font-weight:500; }

    .progress-wrap { max-width:900px; margin:10px auto 0; }
    .progress-head { display:flex; justify-content:space-between; margin-bottom:.35rem; font-weight:600; }
    .progress-outer {
      width:100%; height:14px; background:#1a1b20; border:1px solid #2a2b31; border-radius:999px; overflow:hidden;
      box-shadow:inset 0 1px 2px rgba(0,0,0,.08);
    }
    .progress-inner { height:100%; width:0%; background:linear-gradient(90deg, #5ac8fa, #34c759, #ffd60a); transition:width .35s ease-in-out; }

    .toast-stack { position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:9999; }
    .toast {
      min-width:260px; max-width:360px; padding:.75rem .9rem; border-radius:12px; color:#fff;
      background:#333; box-shadow:0 10px 24px rgba(0,0,0,.25); font-weight:600;
    }
    .toast.ok { background:#2e7d32; }
    .toast.err { background:#c62828; }
    .toast.info { background:#2c3e50; }
    .toast .sub { display:block; font-weight:500; opacity:.9; margin-top:.15rem; }
  </style>
</head>
<body>

  <!-- Hero -->
  <header style="max-width:980px;margin:24px auto 6px;padding:0 12px;text-align:center">
    <img
      src="/img/exwife-hero.png"
      alt="EXWIFE Token"
      loading="lazy"
      style="max-width:100%;height:auto;border-radius:16px;display:inline-block;box-shadow:0 6px 24px rgba(0,0,0,.08)"
    />
    <h1 style="margin:14px 0 4px;font-size:28px;line-height:1.2;">EXWIFE Presale (Mainnet)</h1>
    <p style="margin:0;font-size:16px;opacity:.8">Goal: 1200 ETH • Safe, read-only UI until you connect</p>
  </header>

  <!-- Live banner + countdown -->
  <div id="presaleBanner" class="banner" role="status" aria-live="polite">
    <strong>Presale v3 live until Oct 12</strong>
    <span id="countdown" class="countdown">— calculating…</span>
  </div>

<h1 style="margin:0 0 6px;">EXWIFE Presale</h1>

    <div class="card">
      <div class="row">
        <div class="pill" id="status">Ready</div>
        <div class="pill" id="netPill" style="background:#3f3f46;border-color:#52525b">No Wallet</div>
        <div class="row" style="gap:8px;">
          <button class="btn" id="connectBtn" style="background:#475569">Connect</button>

          <div style="display:flex;gap:8px;align-items:center;background:#1c1d22;border:1px solid #2a2b31;border-radius:10px;padding:6px 8px;">
            <span style="opacity:.8">Amount</span>
            <input id="buyAmount" inputmode="decimal" placeholder="0.01" value="0.01"
                   style="width:90px;background:transparent;border:none;outline:none;color:#e7e7ea;font-weight:600;text-align:right" />
            <span style="opacity:.8">ETH</span>
          </div>

          <button class="btn" id="buyBtn">Buy 0.01 ETH</button>
          <button class="btn" id="refreshBtn" style="background:#374151">Refresh</button>
          <a id="txLink" class="pill" href="#" target="_blank" style="display:none;">View tx</a>
        </div>
      </div>

      <!-- Progress numbers + improved bar (keeps legacy IDs for compatibility) -->
      <div style="margin-top:14px;">
        <div class="progress-head">
          <span>Raised</span>
          <span id="progressNumbers">0.000 / 1200 ETH (0.00%)</span>
        </div>
        <div class="progress-outer" aria-label="Presale progress">
          <div id="progressBar" class="progress-inner" style="width:0%"></div>
        </div>

        <!-- legacy display retained so existing code still paints -->
        <div style="margin-top:10px">Raised: <strong id="raised">0.0000</strong> / <span id="goal-b">1200</span> ETH</div>
        <div class="progress"><div class="bar" id="bar"></div></div>
      </div>

      <div class="muted" style="margin-top:12px; word-break:break-all;">
        Presale: <code id="addr"></code>
        <div style="margin-top:6px;font-size:14px">
          <a id="scanLink" href="#" target="_blank" rel="noopener">View on Etherscan</a>
          <button id="copyBtn" style="margin-left:8px;padding:4px 8px;border:1px solid #2a2b31;border-radius:8px;background:#1c1d22;color:#e7e7ea;cursor:pointer">Copy</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container (notifications) -->
  <div id="toastStack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <!-- Core logic -->
  <script>
    // --- Resilient read-only provider with auto-fallbacks ---
    const RPCS = [
      (window.EXWIFE_ENV && window.EXWIFE_ENV.rpc) || '',
      'https://eth.drpc.org',
      'https://eth-sepolia.public.blastapi.io',
      'https://1rpc.io/sepolia'
    ].filter(Boolean);

    let __RO_PROVIDER = null;
    async function getRO() {
      if (__RO_PROVIDER) return __RO_PROVIDER;
      for (const url of RPCS) {
        try {
          const p = new ethers.JsonRpcProvider(url);
          const ok = await Promise.race([
            p.getBlockNumber(),
            new Promise((_, rej) => setTimeout(() => rej(new Error('RPC timeout')), 2500))
          ]);
          if (typeof ok === 'number') { __RO_PROVIDER = p; return __RO_PROVIDER; }
        } catch {}
      }
      throw new Error('No working RPC endpoint');
    }

    // --- UI helpers ---
    window.EXWIFE_STATE = window.EXWIFE_STATE || { paused: false };
    const el = (id) => document.getElementById(id);

    function setStatus(msg){ const e = el('status'); if (e) e.textContent = msg; }

    // Toasts
    function showToast(msg, sub = '', type = 'info', timeoutMs = 4200) {
      const stack = document.getElementById('toastStack');
      if (!stack) return;
      const item = document.createElement('div');
      item.className = `toast ${type}`;
      item.innerHTML = `${escapeHTML(msg)}${sub ? `<span class="sub">${escapeHTML(sub)}</span>` : ''}`;
      stack.appendChild(item);
      setTimeout(() => { item.style.opacity = '0'; item.style.transform = 'translateY(6px)'; }, timeoutMs - 350);
      setTimeout(() => { stack.removeChild(item); }, timeoutMs);
    }
    function escapeHTML(s){return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

    function updateUI(raisedEth){
      const goal = Number(window.GOAL_ETH || window.EXWIFE_ENV?.goalEth || 1200);

      // numbers
      el('goal-a') && (el('goal-a').textContent = goal);
      el('goal-b') && (el('goal-b').textContent = goal);
      el('raised') && (el('raised').textContent = Math.max(0, raisedEth).toFixed(4));

      // modern progress
      const pct = Math.max(0, Math.min(100, (raisedEth / (goal || 1)) * 100));
      const barModern = el('progressBar');
      const lblModern = el('progressNumbers');
      if (barModern) barModern.style.width = pct.toFixed(2) + '%';
      if (lblModern) lblModern.textContent = `${raisedEth.toFixed(3)} / ${goal} ETH (${pct.toFixed(2)}%)`;

      // legacy bar (kept)
      const pctLegacy = Math.max(1.5, Math.min(100, pct));
      const barLegacy = el('bar');
      if (barLegacy) barLegacy.style.width = pctLegacy + '%';

      // stash for others if needed
      window.__EXWIFE_LAST_RAISED_ETH = raisedEth;
    }

    // --- Network pill updater; enables Buy on Mainnet or Sepolia ---
async function updateNetworkPill() {
  const pill = el('netPill');
  const buyBtn = el('buyBtn');
  if (!pill) return;

  if (!window.ethereum) {
    pill.textContent = 'No Wallet';
    pill.style.background = '#3f3f46';
    pill.style.borderColor = '#52525b';
    if (buyBtn) buyBtn.disabled = true;
    return;
  }

  try {
    const chainIdHex = await window.ethereum.request({ method: 'eth_chainId' });

    if (chainIdHex?.toLowerCase() === '0x1') {
      // Ethereum Mainnet
      pill.textContent = 'Ethereum';
      pill.style.background = '#1e3a8a';
      pill.style.borderColor = '#1d4ed8';
      if (buyBtn) buyBtn.disabled = false;

      const scan = document.getElementById('scanLink');
      if (scan) scan.href = `https://etherscan.io/address/${window.PRESALE_ADDRESS}`;

    } else if (chainIdHex?.toLowerCase() === '0xaa36a7') {
      // Sepolia
      pill.textContent = 'Sepolia';
      pill.style.background = '#134e4a';
      pill.style.borderColor = '#14532d';
      if (buyBtn) buyBtn.disabled = false;

      const scan = document.getElementById('scanLink');
      if (scan) scan.href = `https://sepolia.etherscan.io/address/${window.PRESALE_ADDRESS}`;

    } else {
      // Wrong chain
      pill.textContent = 'Wrong Network';
      pill.style.background = '#7f1d1d';
      pill.style.borderColor = '#991b1b';
      if (buyBtn) buyBtn.disabled = true;

      const scan = document.getElementById('scanLink');
      if (scan) scan.removeAttribute('href');
    }
  } catch (err) {
    console.error('Network detection failed:', err);
    pill.textContent = 'Error';
    pill.style.background = '#7f1d1d';
    pill.style.borderColor = '#991b1b';
    if (buyBtn) buyBtn.disabled = true;
  }
}

    // --- Public: refresh raised with fallbacks ---
    async function EXWIFE_refreshRaised(){
      try {
        const addr = window.PRESALE_ADDRESS, abi = window.PRESALE_ABI_MIN;
        if (!addr) return 0;
        const ro = await getRO();
        const presale = new ethers.Contract(addr, abi, ro);

        let w;
        if (typeof presale.totalRaisedWei === 'function') {
          try { w = await presale.totalRaisedWei(); } catch {}
        }
        if ((!w || w === 0n) && typeof presale.weiRaised === 'function') {
          try { w = await presale.weiRaised(); } catch {}
        }
        if (!w || w === 0n) {
          try { w = await ro.getBalance(addr); } catch {}
        }

        const e = Number(ethers.formatEther(w || 0n));
        updateUI(e);
        return e;
      } catch (err) {
        console.warn("[EXWIFE] EXWIFE_refreshRaised() failed:", err);
        return 0;
      }
    }
    window.EXWIFE_refreshRaised = EXWIFE_refreshRaised;

    // --- Buy flow with custom amount; accepts Mainnet or Sepolia; explorer link adapts ---
    async function buyInline(){
      try {
        setStatus('Connecting…');
        if (!window.ethereum) { showToast("No wallet provider found.", "", "err"); setStatus('No wallet'); return; }

        // Prefer MetaMask if multiple providers are injected
        const mm = (window.ethereum.providers || []).find(p => p.isMetaMask)
                  || (window.ethereum.isMetaMask ? window.ethereum : window.ethereum);

        await mm.request({ method: 'eth_requestAccounts' });

        const provider = new ethers.BrowserProvider(mm);

// Ensure allowed network (prefer Mainnet; allow Sepolia)
const net = await provider.getNetwork();
let chainIdStr = net.chainId?.toString();
if (chainIdStr !== '1' && chainIdStr !== '11155111') {
  try {
    await mm.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: '0x1' }], // Ethereum Mainnet
    });
    const n2 = await provider.getNetwork();
    chainIdStr = n2.chainId?.toString();
  } catch (e) {
    if (e?.code === 4902) {
      await mm.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: '0x1',
          chainName: 'Ethereum Mainnet',
          nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
          rpcUrls: ['https://eth.drpc.org'],
          blockExplorerUrls: ['https://etherscan.io/'],
        }],
      });
      const n2 = await provider.getNetwork();
      chainIdStr = n2.chainId?.toString();
    } else {
      showToast('Please switch to Ethereum Mainnet (or Sepolia) and try again.', '', 'err', 5200);
      setStatus('Wrong network');
      return;
    }
  }
}
await updateNetworkPill();
        }

        const signer  = await provider.getSigner();
        const addr    = window.PRESALE_ADDRESS;
        const abi     = window.PRESALE_ABI_MIN;
        const presale = new ethers.Contract(addr, abi, signer);

        // Amount + validation (you can tune these)
        const raw = (el('buyAmount')?.value || '').trim();
        const amt = Number(raw);
        const MIN = 0.001, MAX = 10;
        if (!isFinite(amt) || amt <= 0) { showToast('Enter an amount in ETH.', '', 'err'); setStatus('Ready'); return; }
        if (amt < MIN)                  { showToast(`Minimum is ${MIN} ETH`, '', 'err');  setStatus('Ready'); return; }
        if (amt > MAX)                  { showToast(`Maximum is ${MAX} ETH`, '', 'err');  setStatus('Ready'); return; }

        setStatus('Submitting tx…');
        showToast('Submitting transaction…', 'Confirm in your wallet', 'info', 3000);
const link = el('txLink');
const explorer = (chainIdStr === '11155111') ? 'https://sepolia.etherscan.io' : 'https://etherscan.io';
if (link) { link.href = `${explorer}/tx/${tx.hash}`; link.style.display=''; }

        // Explorer host depends on chain
        const explorer = (chainIdStr === '11155111') ? 'https://sepolia.etherscan.io' : 'https://etherscan.io';
        if (link) { link.href = `${explorer}/tx/${tx.hash}`; link.style.display=''; }
        showToast('Buy submitted!', tx.hash.slice(0,10) + '…' + tx.hash.slice(-8), 'ok', 5200);
        await tx.wait();
        setStatus('✅ Confirmed');
        await window.EXWIFE_refreshRaised();

      } catch (e) {
        console.error('buy() failed:', e);
        setStatus('❌ Error');
        const msg = (e?.reason || e?.data?.message || e?.message || String(e));
        if (/insufficient funds/i.test(msg)) {
          showToast('Insufficient ETH', 'Top up for gas/amount', 'err', 6000);
        } else if (/user rejected/i.test(msg)) {
          showToast('Transaction rejected', '', 'err', 4200);
        } else {
          showToast('Buy failed', msg, 'err', 6500);
        }
      }
    }

    // --- Paused pill updater; combines with network pill to control BUY ---
    async function updatePausedPill(){
      try {
        const ro = await getRO();
        const c  = new ethers.Contract(window.PRESALE_ADDRESS, window.PRESALE_ABI_MIN, ro);
        let isPaused = false; try { isPaused = await c.paused(); } catch {}
        window.EXWIFE_STATE.paused = isPaused;
        setStatus(isPaused ? 'Paused' : 'Ready');
        await updateNetworkPill();
      } catch {}
    }

    // Countdown banner (America/Chicago close time)
    const PRESALE_CLOSE_UNIX = Math.floor(new Date('2025-10-12T23:59:59-05:00').getTime() / 1000);
    (function bannerCountdown(){
      const countdownEl = document.getElementById('countdown');
      if (!countdownEl) return;
      function render() {
        const now = Math.floor(Date.now() / 1000);
        let diff = PRESALE_CLOSE_UNIX - now;
        if (diff <= 0) { countdownEl.textContent = '— closed'; return; }
        const d = Math.floor(diff / 86400); diff %= 86400;
        const h = Math.floor(diff / 3600);  diff %= 3600;
        const m = Math.floor(diff / 60);    const s = diff % 60;
        countdownEl.textContent = `— ${d}d ${h}h ${m}m ${s}s left`;
      }
      render();
      setInterval(render, 1000);
    })();

    // Optional: RPC/wallet helpful toasts based on the net pill
    (function rpcGuard(){
      const pill = document.getElementById('netPill');
      if (!pill) return;
      const check = () => {
        const t = (pill.textContent || '').trim();
        if (t.includes('No Wallet')) {
} else if (t.includes('Wrong')) {
  showToast('Wrong network', 'Please switch to Ethereum Mainnet (or Sepolia)', 'err', 5000);
}
      };
      setInterval(check, 8000);
      setTimeout(check, 1500);
    })();

    // --- Boot ---
    (function boot(){
      const addr = window.PRESALE_ADDRESS || '(missing)';

      // Static bits
      el('addr') && (el('addr').textContent = addr);
      // Default explorer to Mainnet; will be updated after connect if on Sepolia
el('scanLink') && (el('scanLink').href = `https://etherscan.io/address/${addr}`);

      // Listeners
      el('copyBtn')?.addEventListener('click', () => navigator.clipboard.writeText(addr));
      el('refreshBtn')?.addEventListener('click', () => EXWIFE_refreshRaised());
      el('connectBtn')?.addEventListener('click', async () => {
        if (!window.ethereum) { showToast('Install MetaMask to connect.', '', 'info'); return; }
        const mm = (window.ethereum.providers || []).find(p => p.isMetaMask)
                  || (window.ethereum.isMetaMask ? window.ethereum : window.ethereum);
        await mm.request({ method: 'eth_requestAccounts' });
        setStatus('Wallet connected');
        updateNetworkPill();
      });
      el('buyBtn')?.addEventListener('click', buyInline);

      // Keep Buy label in sync with amount
      const amt = el('buyAmount'); const buy = el('buyBtn');
      if (amt && buy) {
        const sync = () => { buy.textContent = `Buy ${amt.value || '0.01'} ETH`; };
        amt.addEventListener('input', sync); sync();
      }

      // React to wallet changes
      if (window.ethereum?.on) {
        window.ethereum.on('chainChanged', () => updateNetworkPill());
        window.ethereum.on('accountsChanged', () => updateNetworkPill());
      }

      // Initial paint + auto-refresh + initial pills
      const tick = async () => { try { await window.EXWIFE_refreshRaised(); } catch (e) { console.warn('tick failed:', e); } };
      tick();
      updatePausedPill();
      updateNetworkPill();
      window.EXWIFE_AUTO = window.EXWIFE_AUTO || {};
      clearInterval(window.EXWIFE_AUTO.raised);
      window.EXWIFE_AUTO.raised = setInterval(tick, 20000);
      document.addEventListener('visibilitychange', () => { if (!document.hidden) tick(); });

      console.log('EXWIFE v12.3 loaded (goal:', window.GOAL_ETH, 'ETH)');
    })();
  </script>

  <!-- Toasts UI (kept) -->
  <style>
    #exwifeToastHost{position:fixed;right:16px;top:16px;z-index:99999;display:flex;flex-direction:column;gap:10px;pointer-events:none}
    .exwifeToast{min-width:280px;max-width:360px;background:#101010;color:#eee;border:1px solid #2b2b2b;border-radius:14px;
      padding:10px 12px;box-shadow:0 10px 30px rgba(0,0,0,.35);font:14px/1.3 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      pointer-events:auto;opacity:0;transform:translateY(-6px);transition:opacity .18s ease, transform .18s ease}
    .exwifeToast.show{opacity:1;transform:translateY(0)}
    .exwifeToast .hdr{display:flex;align-items:center;gap:8px;font-weight:700;margin-bottom:4px}
    .exwifeToast .msg{opacity:.9;word-wrap:break-word}
    .exwifeToast.success{border-color:#235c2a}
    .exwifeToast.success .dot{width:10px;height:10px;border-radius:999px;background:#8df58d}
    .exwifeToast.error{border-color:#6a2525}
    .exwifeToast.error .dot{width:10px;height:10px;border-radius:999px;background:#ff8a8a}
    .exwifeToast.info{border-color:#2b2b2b}
    .exwifeToast.info .dot{width:10px;height:10px;border-radius:999px;background:#9bb2ff}
    .exwifeToast .x{margin-left:auto;opacity:.7;cursor:pointer}
  </style>
  <div id="exwifeToastHost" aria-live="polite"></div>
  <script>
  (() => {
    const host = document.getElementById('exwifeToastHost');
    function makeToast(type, title, message, ms=4200){
      const el = document.createElement('div');
      el.className = `exwifeToast ${type}`;
      el.innerHTML = `
        <div class="hdr"><span class="dot"></span><span>${title}</span>
          <span class="x" title="Close">✕</span>
        </div>
        <div class="msg">${message || ''}</div>`;
      host.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('show'));
      const close = ()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),180); };
      el.querySelector('.x').onclick = close;
      if (ms>0) setTimeout(close, ms);
    }
    window.EXWIFE_toast       = (m)=>makeToast('info','Notice', m, 3200);
    window.EXWIFE_toastSuccess= (m)=>makeToast('success','Success', m, 4200);
    window.EXWIFE_toastError  = (m)=>makeToast('error','Error', m, 5200);
  })();
  </script>

  <!-- Progress Animation (kept) -->
  <style>
    #progFill, [data-exwife-progress-fill]{ transition: width .9s cubic-bezier(.22,.8,.26,.99); will-change: width; }
  </style>
  <script>
  (() => {
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function setFill(pct){
      const el = document.getElementById('progFill') || document.querySelector('[data-exwife-progress-fill]');
      if (el) el.style.width = clamp(pct,0,100).toFixed(2) + '%';
    }
    async function computePct() {
      const goal = Number(window.GOAL_ETH || window?.EXWIFE_ENV?.goalEth || 0);
      if (!goal || !isFinite(goal)) return null;
      let raised = null;
      try {
        const n = document.querySelector('[data-exwife-raised], #raisedAmount, .raised-amount');
        if (n) raised = Number(String(n.textContent).replace(/[^\d.]/g,'')) || null;
      } catch {}
      if (raised == null && typeof window.EXWIFE_lastRaised === 'number') raised = window.EXWIFE_lastRaised;
      if (raised == null) return null;
      return clamp((raised / goal) * 100, 0, 100);
    }
    if (typeof window.EXWIFE_refreshRaised === 'function') {
      const _orig = window.EXWIFE_refreshRaised;
      window.EXWIFE_refreshRaised = async function(...args){
        const out = await _orig.apply(this, args);
        try {
          const pct = await computePct();
          if (pct != null) setFill(pct);
        } catch {}
        return out;
      };
    }
    setTimeout(async ()=>{ const p = await computePct(); if (p!=null) setFill(p); }, 250);
  })();
  </script>

  <!-- Owner Panel (kept; now neutral to network) -->
  <style>
    #ownerPanel{position:fixed;right:12px;bottom:12px;z-index:9999}
    #ownerPanel details{background:#111;color:#eee;border:1px solid #333;border-radius:16px;padding:10px 12px;box-shadow:0 6px 24px rgba(0,0,0,.35);min-width:320px}
    #ownerPanel summary{cursor:pointer;list-style:none;font-weight:700}
    #ownerPanel .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    #ownerPanel button{border:1px solid #2b2b2b;border-radius:12px;padding:8px 10px;cursor:pointer;background:#1b1b1b;color:#fff}
    #ownerPanel button[disabled]{opacity:.45;cursor:not-allowed}
    #ownerPanel .pill{display:inline-block;border:1px solid #2b2b2b;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px}
    #ownerPanel .ok{color:#8df58d;border-color:#285e28}
    #ownerPanel .warn{color:#ffd16b;border-color:#7a5b24}
    #ownerPanel .bad{color:#ff8a8a;border-color:#6a2525}
    #ownerPanel .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>

  <div id="ownerPanel">
    <details>
      <summary>Owner Panel
        <span id="opNet"  class="pill mono">…</span>
        <span id="opStat" class="pill mono">…</span>
      </summary>
      <div style="margin-top:8px;font-size:12px;opacity:.8">
        Presale: <span class="mono" id="opAddr">...</span>
      </div>
      <div class="row">
        <button id="opConnectBtn" title="Connect wallet (user-initiated)">Connect</button>
        <button id="opRefreshBtn" title="Refresh panel/status">Refresh</button>
      </div>
      <div style="margin-top:8px;font-size:12px">
        Wallet: <span id="opAcct" class="mono">not connected</span>
      </div>
      <div style="margin-top:8px">
        Raised: <span id="opRaised" class="mono">…</span> ETH
      </div>
      <div class="row" style="margin-top:10px">
        <button id="opPauseBtn"   title="This presale is windowed; pause/unpause not available" disabled>Pause (n/a)</button>
        <button id="opUnpauseBtn" title="This presale is windowed; pause/unpause not available" disabled>Unpause (n/a)</button>
        <button id="opWithdrawBtn">Withdraw</button>
        <button id="opFinalizeBtn">Finalize</button>
      </div>
      <div id="opMsg" style="margin-top:8px;font-size:12px;opacity:.85"></div>
    </details>
  </div>

  <script>
  (() => {
    if (window.__EXWIFE_OWNER_INIT) return; window.__EXWIFE_OWNER_INIT = true;
    [...document.querySelectorAll('#ownerPanel')].slice(1).forEach(n => n.remove());

    const OWNER_ADDRESS    = "0x4799d7Bf70371A396E3415336DD821586A72D37e";
    const PRESALE          = window.PRESALE_ADDRESS || window?.EXWIFE_ENV?.presale;
    const RPC_URL          = (window.EXWIFE_ENV && window.EXWIFE_ENV.rpc) || "https://eth.drpc.org";

    const $ = (id)=>document.getElementById(id);
    const el = {
      net: $('opNet'), stat: $('opStat'), addr: $('opAddr'),
      connect: $('opConnectBtn'), refresh: $('opRefreshBtn'),
      acct: $('opAcct'), raised: $('opRaised'),
      withdraw: $('opWithdrawBtn'), finalize: $('opFinalizeBtn'),
      msg: $('opMsg')
    };
    if (el.addr) el.addr.textContent = PRESALE || '(missing)';

    const ABI = [
      "function totalRaisedWei() view returns (uint256)",
      "function weiRaised() view returns (uint256)",
      "function withdraw()",
      "function finalize()",
      "function owner() view returns (address)"
    ];

    const providerFromPage = () => window.ethereum ? new ethers.BrowserProvider(window.ethereum)
                                                    : new ethers.JsonRpcProvider(RPC_URL);

    async function passiveAccounts(){ try { return await window.ethereum?.request?.({method:"eth_accounts"}) || []; } catch { return []; } }
    async function connectInteractive(){
      if (!window.ethereum?.request) throw new Error("No wallet");
      return await window.ethereum.request({ method: "eth_requestAccounts" });
    }

    function setMsg(m){ if (el.msg) el.msg.textContent = m || ""; }
    const short = (a)=> a ? (a.slice(0,6)+"…"+a.slice(-4)) : "";

    async function readRaised(c){
      try { const w=await c.totalRaisedWei(); return Number(ethers.formatEther(w)); } catch {}
      try { const w=await c.weiRaised();      return Number(ethers.formatEther(w)); } catch {}
      try { const p=providerFromPage(); const b=await p.getBalance(PRESALE); return Number(ethers.formatEther(b)); } catch {}
      return NaN;
    }

    async function refreshPanel(passive=true){
      setMsg("Refreshing…");
      const provider = providerFromPage();

      let chainId=null;
      try { const net=await provider.getNetwork(); chainId = net.chainId?.toString(); } catch {}
      if (!el.net) {/*no-op*/}
      else if (!chainId) { el.net.textContent="No RPC"; el.net.className="pill bad"; }
      else if (chainId === "1") { el.net.textContent="Ethereum"; el.net.className="pill ok"; }
else if (chainId === "1") { el.net.textContent="Ethereum"; el.net.className="pill ok"; }
else if (chainId === "11155111") { el.net.textContent="Sepolia"; el.net.className="pill ok"; }
else { el.net.textContent=`Chain ${chainId}`; el.net.className="pill warn"; }
      const accts = passive ? await passiveAccounts() : [];
      if (el.acct) el.acct.textContent = accts[0] ? short(accts[0]) : "not connected";

      const signer = (accts[0] && provider.getSigner) ? await provider.getSigner() : null;
      const runner = signer || provider;
      const contract = (PRESALE && runner) ? new ethers.Contract(PRESALE, ABI, runner) : null;

      if (contract && el.raised) {
        const r = await readRaised(contract);
        el.raised.textContent = Number.isFinite(r) ? r.toFixed(3) : "n/a";
        try { if (typeof window.EXWIFE_refreshRaised === "function") await window.EXWIFE_refreshRaised(); } catch {}
      }

      // v3 is window-based
      if (el.stat) { el.stat.textContent = "Open (window)"; el.stat.className = "pill ok"; }

      // Owner controls available if connected account equals OWNER_ADDRESS (on either allowed chain)
      const isOwner = accts[0] && (accts[0].toLowerCase() === OWNER_ADDRESS.toLowerCase()) && (chainId === "1" || chainId === "11155111");
      [el.withdraw, el.finalize].forEach(b => { if (b) b.disabled = !isOwner; });

      if (el.connect) el.connect.style.display = accts.length ? "none" : "inline-block";
      setMsg("");
    }

    async function ownerAction(fn, successNote){
      try{
        setMsg("Sending…");
        const provider = providerFromPage();
        const net = await provider.getNetwork();
        const id = (net.chainId?.toString());
const id = net.chainId?.toString();
if (id !== "1" && id !== "11155111") throw new Error("Wrong network");
        const [acct] = await passiveAccounts();
        if (!acct) throw new Error("Connect wallet");
        if (acct.toLowerCase() !== OWNER_ADDRESS.toLowerCase()) throw new Error("Not owner");

        const signer = await provider.getSigner();
        const c = new ethers.Contract(PRESALE, ABI, signer);
        const tx = await c[fn]();
        window.EXWIFE_txSent?.(tx.hash);
        await tx.wait();
        window.EXWIFE_txConfirmed?.();
        setMsg(successNote || "Done.");
        try { if (typeof window.EXWIFE_refreshRaised === "function") await window.EXWIFE_refreshRaised(); } catch {}
        await refreshPanel(true);
      } catch(e){
        const msg = e?.reason || e?.message || String(e);
        window.EXWIFE_toastError?.(msg);
        setMsg(`Error: ${msg}`);
      }
    }

    el.refresh?.addEventListener('click', () => refreshPanel(true));
    el.connect?.addEventListener('click', async () => { try{ setMsg("Connecting…"); await connectInteractive(); await refreshPanel(true); setMsg(""); } catch(e){ setMsg(`Connect failed: ${e?.message||e}`);} });
    el.withdraw?.addEventListener('click', () => ownerAction('withdraw',  'Withdrawn.'));
    el.finalize?.addEventListener('click', () => ownerAction('finalize', 'Finalized.'));

    refreshPanel(true);
    setInterval(()=>refreshPanel(true), 20000);
  })();
  </script>

  <!-- Force mainnet reader block was removed (we already have EXWIFE_refreshRaised above) -->

</body>
</html>

